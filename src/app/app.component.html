<!-- Bot√≥n de men√∫ hamburguesa SOLO en m√≥viles -->
<button class="menu-toggle" (click)="toggleSidebar()">‚ò∞</button>

<!-- Men√∫ horizontal en pantallas grandes -->
<nav class="topnav">
  <ul class="menu-centro">
    <li><a routerLink="/">INICIO</a></li>
    <li><a routerLink="/nosotros">NOSOTROS</a></li>
    <li><a routerLink="/categorias">CATEGOR√çAS</a></li>
    <!-- Los enlaces a MAPA y JUEGO solo se mostrar√°n si el usuario est√° logueado -->
    <li *ngIf="usuarioLogueado"><a routerLink="/mapa">MAPA</a></li>
    <li *ngIf="usuarioLogueado"><a routerLink="/juego">JUEGO</a></li>
    <li><a routerLink="/noticias">NOTICIAS</a></li>
  </ul>

  <div class="login-wrapper">
    <!-- Contenedor para el bot√≥n de Iniciar Sesi√≥n cuando NO hay usuario logueado -->
    <ng-container *ngIf="!usuarioLogueado; else bienvenido">
      <button class="login-btn" (click)="abrirModal()">
        <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt="Login Icon" class="icono-btn" />
        Iniciar sesi√≥n
      </button>
    </ng-container>

    <!-- Plantilla que se muestra cuando el usuario S√ç est√° logueado -->
    <ng-template #bienvenido>
      <div class="usuario-bienvenido">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User Icon" class="avatar-usuario" />
        
        <div class="texto-bienvenida" (click)="toggleMenu()" style="cursor: pointer;">
          <!-- Se asume que usuarioLogueado.nombre existe, si no, puedes usar usuarioLogueado.correo -->
          <p class="saludo">¬°Bienvenido,</p>
          <p class="nombre-usuario">{{ usuarioLogueado.nombre  }}!</p>
          
        </div>

        <!-- Men√∫ desplegable del usuario (Cambiar contrase√±a, Cerrar sesi√≥n) -->
        <div class="menu-usuario" *ngIf="menuVisible">
          <button class="btn-opcion" (click)="irAPerfil()">Mi perfil</button>
          <button class="btn-opcion" (click)="irACursos()">Cursos</button> <!-- NUEVO BOT√ìN -->
          <button class="btn-opcion" (click)="irAHistorial()">Historial de Reciclaje</button> <!-- NUEVO BOT√ìN -->
          <button class="btn-opcion" (click)="cambiarContrasena()">Cambiar contrase√±a</button>
          <button class="btn-opcion cerrar" (click)="cerrarSesion()">Cerrar sesi√≥n</button>
        </div>
      </div>
    </ng-template>
  </div>
</nav>

<!-- Modal Cambiar Contrase√±a -->
<div class="modal-cambiar-contrasena" *ngIf="mostrarModalCambiarClave">
  <div class="modal-content">
    <h2>Cambiar Contrase√±a</h2>
    <div class="campo-usuario-logueado">
      <label>Correo actual</label>
      <input type="email" [value]="usuarioLogueado?.correo" disabled>
    </div>

    <input type="password" [(ngModel)]="nuevaContrasena" placeholder="Nueva Contrase√±a">
    <input type="password" [(ngModel)]="confirmarContrasena" placeholder="Confirmar Contrase√±a">
    <div [ngClass]="mensajeErrorClave.includes('‚úÖ') ? 'mensaje-exito' : 'mensaje-error'" *ngIf="mensajeErrorClave">
      {{ mensajeErrorClave }}
    </div>

    <div class="acciones">
      <button (click)="guardarNuevaContrasena()">Guardar</button>
      <button (click)="cerrarModalCambiarClave()">Cancelar</button>
    </div>
  </div>
</div>


<!-- Sidebar solo en m√≥viles -->
<nav class="sidebar" [class.open]="sidebarOpen">
  <button class="close-btn" (click)="toggleSidebar()">‚úñ</button>
  <ul>
    <li><a routerLink="/" (click)="toggleSidebar()">INICIO</a></li>
    <li><a routerLink="/nosotros" (click)="toggleSidebar()">NOSOTROS</a></li>
    <li><a routerLink="/categorias" (click)="toggleSidebar()">CATEGOR√çAS</a></li>
    <!-- Los enlaces a MAPA y JUEGO en el sidebar solo se mostrar√°n si el usuario est√° logueado -->
    <li *ngIf="usuarioLogueado"><a routerLink="/mapa" (click)="toggleSidebar()">MAPA</a></li>
    <li *ngIf="usuarioLogueado"><a routerLink="/juego" (click)="toggleSidebar()">JUEGO</a></li>
    <li><a routerLink="/noticias" (click)="toggleSidebar()">NOTICIAS</a></li>

    <!-- Secci√≥n de usuario en el sidebar -->
    <li style="padding: 0; margin: 0;">
      <div class="usuario-sidebar">
        
        <!-- üëâ Usuario no logueado: Muestra el bot√≥n de Iniciar Sesi√≥n -->
        <div class="info-usuario" *ngIf="!usuarioLogueado" (click)="abrirModal()" style="cursor: pointer;">
          <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt="icono login" class="icono-usuario" />
          <div class="datos-usuario">
            <span class="nombre-usuario">Iniciar sesi√≥n</span>
          </div>
        </div>

        <!-- üë§ Usuario logueado: Muestra la informaci√≥n del usuario y su submen√∫ -->
        <div *ngIf="usuarioLogueado">
          <div class="info-usuario" (click)="toggleSidebarMenu()" style="cursor: pointer;">
            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="icono-usuario" />
            <div class="datos-usuario">
              <!-- Se asume que usuarioLogueado.nombre existe, si no, puedes usar usuarioLogueado.correo -->
              <span class="nombre-usuario">{{ usuarioLogueado.nombre || usuarioLogueado.correo }}</span>
            </div>
          </div>

          <!-- üîΩ Submen√∫ del usuario en el sidebar -->
          <div class="submenu-opciones" *ngIf="menuVisibleSidebar">
            <button class="btn-opcion" (click)="irAPerfil()">Mi perfil</button>
            <button class="btn-opcion" (click)="irACursos()">Cursos</button> <!-- NUEVO BOT√ìN -->
            <button class="btn-opcion" (click)="irAHistorial()">Historial de Reciclaje</button> <!-- NUEVO BOT√ìN -->
            <button class="btn-opcion" (click)="cambiarContrasena()">Cambiar contrase√±a</button>
            <button class="btn-opcion cerrar" (click)="cerrarSesion()">Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>
    </li>
  </ul>
</nav>


<!-- Contenido de la app (Aqu√≠ se cargan los componentes de las rutas) -->
<router-outlet></router-outlet>

<!-- Modal de Login/Registro -->
<div class="modal-backdrop" *ngIf="modalAbierto"></div>

<div class="modal" *ngIf="modalAbierto">
  <!-- Bot√≥n X para cerrar el modal -->
  <button class="modal-close" (click)="cerrarModal()">‚úñ</button>

  <div class="modal-contenido">
    <div class="icono-login">
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="login icon" />
    </div>

    <h2 *ngIf="modo === 'login'">Iniciar Sesi√≥n</h2>
    <h2 *ngIf="modo === 'registro'">Crear Cuenta</h2>

    <!-- Formulario de Login -->
    <form *ngIf="modo === 'login'" (ngSubmit)="login()" class="formulario-login" autocomplete="off">
      <label for="email">Correo electr√≥nico</label>
      <input type="email" id="email" [(ngModel)]="loginEmail" name="email" required />

      <label for="password">Contrase√±a</label>
      <input type="password" id="password" [(ngModel)]="loginPassword" name="password" required />

      <button type="submit" class="btn-ingresar">Ingresar</button>
      
      <p class="opciones">
        <a href="#" (click)="abrirModalRecuperacion(); $event.preventDefault()">
          ¬øOlvidaste la contrase√±a?
        </a>
      </p>
    </form>

    <!-- Formulario de Registro -->
    <form *ngIf="modo === 'registro'" (ngSubmit)="registrar()" class="formulario-login" autocomplete="off">
      <label for="nombre">Nombres</label>
      <input type="text" id="nombre" [(ngModel)]="registroNombre" name="nombre" required />

      <label for="apellidos">Apellidos</label>
      <input type="text" id="apellido" [(ngModel)]="registroApellidos" name="apellido" required />

      <label for="tipoDocumento">Tipo de documento</label>
        <div class="documento-linea">
          <select id="tipoDocumento" [(ngModel)]="registroTipoDoc" name="tipoDocumento" (change)="limpiarDocumento()" required>
            <option value="DNI">DNI</option>
            <option value="CE">Carn√© de Extranjer√≠a</option>
          </select>

          <input
            type="text"
            id="documento"
            [(ngModel)]="registroDocumento"
            name="documento"
            required
            inputmode="numeric"
            maxlength="12"
            placeholder="N√∫mero de documento"
            (keypress)="soloNumeros($event)"
            (input)="validarDocumento()"
          />
        </div>
        <div *ngIf="documentoInvalido" class="error-mensaje">
            {{ mensajeErrorDocumento }}
        </div>  

      <label for="fechaNacimiento">Fecha de nacimiento</label>
      <input
        type="date"
        id="fechaNacimiento"
        [(ngModel)]="registroFechaNacimiento"
        (change)="validarEdad()"
        name="fechaNacimiento"
        required
        class="input-date"
      />
       <small class="error" *ngIf="errorEdad">{{ errorEdad }}</small>
       
      <label for="correo">Correo electr√≥nico</label>
      <input type="email" id="correo" [(ngModel)]="registroCorreo" name="correo" required />

      <label for="clave">Contrase√±a</label>
      <input type="password" id="clave" [(ngModel)]="registroClave" name="clave" required />

      <input type="hidden" id="ubicacion" [(ngModel)]="registroUbicacion" name="ubicacion" required />

      <button type="submit" class="btn-ingresar" [disabled]="documentoInvalido">Registrar</button>
    </form>



    <!-- Bot√≥n Google solo en login -->
    <button *ngIf="modo === 'login'" class="google-btn" type="button">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" />
      Continuar con Google
    </button>

    <!-- Opciones para cambiar entre Login y Registro -->
    <p class="texto-secundario">
      <ng-container *ngIf="modo === 'login'">
        ¬øNo tienes cuenta?
        <!--<a href="#" (click)="modo = 'registro'; $event.preventDefault()">Reg√≠strate</a>-->
        <a href="#" (click)="cambiarAModoRegistro(); $event.preventDefault()">Reg√≠strate</a>
      </ng-container>
      <ng-container *ngIf="modo === 'registro'">
        ¬øYa tienes cuenta?
        <!--<a href="#" (click)="modo = 'login'; $event.preventDefault()">Inicia sesi√≥n</a>-->
        <a href="#" (click)="cambiarAModoLogin(); $event.preventDefault()">Inicia sesi√≥n</a>
      </ng-container>
    </p>

    <!-- Mensaje de error debajo de las opciones de login/registro -->
    <span *ngIf="mensajeError" style="color: red; font-weight: bold; display: block; text-align: center; margin-top: 0.5rem;">
      {{ mensajeError }}
    </span>

  </div>
</div>


<!-- Modal de Registro Exitoso (se muestra brevemente) -->
<div class="modal-exito" *ngIf="registroExitoso">
  ‚úÖ Usuario registrado correctamente
</div>


<!-- Modal de Bienvenida -->
<div class="modal-bienvenida" *ngIf="mostrarBienvenida">
  üëã ¬°Bienvenido, {{ usuarioLogueado?.nombre || 'usuario' }}!
</div>


<!-- üü¢ Modal de conexi√≥n/desconexi√≥n -->
<div *ngIf="mostrarEstadoConexion" class="modal-conexion" [ngClass]="estadoConexion">
  <span *ngIf="estadoConexion === 'offline'">üî¥ Sin conexi√≥n a internet</span>
  <span *ngIf="estadoConexion === 'online'">üü¢ Conexi√≥n restablecida</span>
</div>


<div class="modal-recuperacion" *ngIf="mostrarModalRecuperacion">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Recuperar Contrase√±a</h5>
      <button type="button" class="btn-close" (click)="cerrarModalRecuperacion()">√ó</button>
    </div>
    <div class="modal-body">
      <p>Introduce tu correo electr√≥nico para restaurar tu contrase√±a.</p>
      <input type="email" [(ngModel)]="correoRecuperacion" placeholder="Correo electr√≥nico" required>
      <p class="mensaje-error" *ngIf="mensajeErrorRecuperacion">
        {{ mensajeErrorRecuperacion }}
      </p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-primary" (click)="enviarCorreoRecuperacion()">Enviar correo</button>
      <button type="button" class="btn-secondary" (click)="cerrarModalRecuperacion()">Cancelar</button>
    </div>
  </div>
</div>


<!-- Footer de la aplicaci√≥n -->
<footer style="background-color: #333; color: white; padding: 1rem; text-align: center; margin-top: auto;">
  ¬© 2025 EcoRecicla. Todos los derechos reservados.
</footer>
