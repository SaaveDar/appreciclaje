<div class="perfil-contenedor">
  <h2>ğŸ‘¤ Bienvenido, {{ nombreUsuario }} {{ apellidoUsuario }}</h2>

  <div class="datos-personales">
    <p>ğŸ‚ Edad: <strong>{{ edad }}</strong> </p>
    <p>ğŸªª Tipo de documento: <strong>{{ tipoDocumento }}</strong></p>
    <p>ğŸ”¢ Documento: <strong>{{ documento }}</strong></p>
    <p>ğŸ“… Fecha de registro: <strong>{{ fechaRegistro }}</strong></p>
    <p>ğŸ”‘ Tipo de usuario: <strong>{{ tipoUsuario }}</strong></p>
    <p>ğŸ“§ Correo: <strong>{{ correoUsuario }}</strong></p>
  </div>

  <div class="stats">
    <p>ğŸ† Puntaje total: <strong>{{ puntaje }}</strong></p>
    <p>ğŸ¯ Nivel actual: <strong>{{ nivel }}</strong></p>
    <p>ğŸ¥‡ Medallas obtenidas: <span style="font-size: 1.5rem;">{{ medallas }}</span></p>
  </div>

<div class="cursos-canje">
  <h3>ğŸ“ Cursos disponibles para canjear</h3>

  <!-- Si hay cursos disponibles -->
  <ul *ngIf="cursosDisponibles.length > 0; else sinCursos">
    <li *ngFor="let curso of cursosDisponibles">
      âœ… {{ curso }}
    </li>
  </ul>

  <!-- Si NO hay cursos disponibles -->
  <ng-template #sinCursos>
    <p *ngIf="puntaje === 0">
      âŒ AÃºn no tienes puntos suficientes para canjear cursos.
    </p>
    <p *ngIf="puntaje > 0">
      ğŸ’¡ Â¡Aprovecha en canjear tus puntos con algunos cursos de tu interÃ©s!
    </p>
  </ng-template>
</div>

    

  <!-- âœ… Solo ADMIN y DOCENTE ven las pestaÃ±as -->
  <div class="perfil-container">

    <div *ngIf="puedeVerCursos() || puedeVerUsuarios()" class="tabs">
      <div class="tab" [class.active]="mostrarTablaUsuarios" *ngIf="puedeVerUsuarios()" (click)="verUsuarios()">
        Usuarios Registrados
      </div>
      <div class="tab" [class.active]="mostrarTablaCursos" *ngIf="puedeVerCursos()" (click)="listarCursos()">
        Cursos con CertificaciÃ³n
      </div>
    </div>

    <!-- Tabla de usuarios (solo admin) -->
    <div class="contenido" *ngIf="mostrarTablaUsuarios">
      <div class="filtros">
        <input type="text" [(ngModel)]="filtroNombre" (input)="filtrarUsuarios()" placeholder="Buscar por nombre o apellido...">
        <select [(ngModel)]="cantidadFilas" (change)="filtrarUsuarios()">
          <option [value]="10">10 filas</option>
          <option [value]="50">50 filas</option>
          <option [value]="100">100 filas</option>
        </select>
      </div>

      <div class="tabla-responsive">
       <table class="tabla-usuarios">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombres y Apellidos</th>
              <th>Correo</th>
              <th>Tipo</th>
              <th>Ultimo acceso</th>
              <th *ngIf="usuarioLogueado?.tipo_usuario === 'administrador'">AcciÃ³n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of usuariosFiltrados">
              <td>{{ u.id }}</td>
              <td>{{ u.nombre + ' ' + u.apellido }}</td>
              <td>{{ u.correo }}</td>
              <td>{{ u.tipo_usuario }}</td>
              <td>
                <span *ngIf="u.en_linea === 1">ğŸŸ¢ En lÃ­nea</span>
                <span *ngIf="u.en_linea === 0">
                  Ãšltima conexiÃ³n: 
                  {{ u.ultima_conexion | date:'d \'de\' MMMM \'de\' y, HH:mm' }} 
                  ({{ u.ultima_conexion ? obtenerTiempoTranscurrido(u.ultima_conexion) : '' }})
                </span>
              </td>
              <td *ngIf="usuarioLogueado?.tipo_usuario === 'administrador'">
                <div class="permiso-actions">
                  <button
                    *ngIf="u.permiso_reciclaje !== 'activo'"
                    (click)="otorgarPermisoReciclaje(u)"
                  >
                    Dar Permiso
                  </button>
                  
                  <ng-container *ngIf="u.permiso_reciclaje === 'activo'">
                    <span class="permiso-otorgado">Permiso Otorgado âœ…</span>
                    <button
                      (click)="revocarPermisoReciclaje(u)"
                      class="btn-revocar"
                    >
                      Revocar Permiso
                    </button>
                  </ng-container>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- BotÃ³n para mostrar u ocultar tabla -->
<div class="botones-cursos" *ngIf="tipoUsuario === 'estandar'">
  <button *ngIf="puedeCanjearAlgunCurso()" (click)="mostrarTablaCanje = !mostrarTablaCanje">
    ğŸ“‹ {{ mostrarTablaCanje ? 'Ocultar cursos para canjear' : 'Ver cursos para canjear' }}
  </button>

  <button (click)="mostrarCursosCanjeados = !mostrarCursosCanjeados">
    ğŸ“ {{ mostrarCursosCanjeados ? 'Ocultar cursos canjeados' : 'Ver cursos canjeados' }}
  </button>
</div>



    <!-- Tabla con canje solo para estÃ¡ndar, siempre visible -->
    <div class="contenido" *ngIf="tipoUsuario === 'estandar' && mostrarTablaCanje">
      <div class="tabla-responsive">
        <table class="tabla-usuarios">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>DuraciÃ³n</th>
              <th>Horario</th>
              <th>Precio</th>
              <th>Modalidad</th>
              <th>Incluye</th>
              <th>Canjear</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of cursosFiltrados">
              <td>{{ c.nombre }}</td>
              <td>{{ c.duracion }}</td>
              <td>{{ c.horario }}</td>
              <td>
                S/ {{ c.precio }}<br>
                ğŸŸ¢ {{ calcularPuntosRequeridos(c.precio) }} puntos
              </td>

              <td>{{ c.modalidad }}</td>
              <td>{{ c.extra }}</td>
              <td><button (click)="canjearCurso(c)">ğŸ Canjear</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tabla de cursos ya canjeados -->
<div *ngIf="mostrarCursosCanjeados">
  <table class="tabla-cursos">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>DuraciÃ³n</th>
        <th>Horario</th>
        <th>Modalidad</th>
        <th>Incluye</th>
        <th>Precio</th>
        <th>Fecha Canje</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let curso of cursosCanjeados">
        <td>{{ curso.nombre }}</td>
        <td>{{ curso.duracion }}</td>
        <td>{{ curso.horario }}</td>
        <td>{{ curso.modalidad }}</td>
        <td>{{ curso.extra }}</td>
        <td>S/. {{ curso.precio }}</td>
        <td>{{ curso.fecha_canje }}</td>
      </tr>
    </tbody>
  </table>
</div>

    
    <div *ngIf="tipoUsuario === 'estandar'" class="qr-bonus">
      <div class="qr-bonus-texto">
        <h3>ğŸ”„ Â¡Convierte tus Reciclajes en Recompensas!</h3>
        <p>
          Cada vez que lleves tus residuos reciclables a un punto ecolÃ³gico y escanees el cÃ³digo QR, 
          estarÃ¡s sumando <strong>tiempo ecolÃ³gico</strong> ğŸŒ±, desbloqueando <strong>beneficios</strong> y 
          subiendo de nivel en tu compromiso por el planeta. â™»ï¸
        </p>
        <p style="margin-top: 0.5rem;">
          ğŸ“ Â¡Encuentra un punto, escanea y gana! Â¡El cambio comienza contigo! ğŸ’š
        </p>
      </div>
      
      <button (click)="camaraActiva = true">ğŸ“² Escanear CÃ³digo QR</button>
      <p *ngIf="mensajeQR" style="margin-top: 0.5rem;">{{ mensajeQR }}</p>

      <zxing-scanner
        *ngIf="camaraActiva"
        [formats]="formatoQR"
        (scanSuccess)="procesarCodigoQR($event)">
      </zxing-scanner>


      <button *ngIf="camaraActiva" (click)="camaraActiva = false">âŒ Cerrar cÃ¡mara</button>
    </div>

    <!-- Tabla completa solo para admin/docente -->
    <div class="contenido" *ngIf="mostrarTablaCursos && (puedeVerCursos() || puedeVerUsuarios())">
      <div class="filtros">
        <input type="text" [(ngModel)]="filtroNombre" (input)="filtrarCursos()" placeholder="Buscar cursos...">
        <select [(ngModel)]="cantidadFilas" (change)="filtrarCursos()">
          <option [value]="10">10 filas</option>
          <option [value]="50">50 filas</option>
          <option [value]="100">100 filas</option>
        </select>
        <button (click)="modalCurso.showModal()">â• Nuevo Curso</button>
      </div>

      <div class="tabla-responsive">
        <table class="tabla-usuarios">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>DuraciÃ³n</th>
              <th>Horario</th>
              <th>Precio</th>
              <th>Modalidad</th>
              <th>Incluye</th>
              <th>Estado</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of cursosFiltrados">
              <td>{{ c.id }}</td>
              <td>{{ c.nombre }}</td>
              <td>{{ c.duracion }}</td>
              <td>{{ c.horario }}</td>
              <td>S/ {{ c.precio }}</td>
              <td>{{ c.modalidad }}</td>
              <td>{{ c.extra }}</td>
              <td>
                <span [ngStyle]="{'color': c.estado === 'activo' ? 'green' : 'red', 'font-weight': 'bold'}">
                  {{ c.estado }}
                </span>
              </td>
              <td><button (click)="editarCurso(c)">âœï¸ Editar</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  <dialog #modalEditarCurso>
    <h3>âœï¸ Editar Curso</h3>
    <form (submit)="guardarEdicion(); modalEditarCurso.close(); $event.preventDefault()">
        <input type="text" placeholder="Nombre del curso" [(ngModel)]="cursoAEditar.nombre" name="nombre_edit" required>
        <input type="text" placeholder="DuraciÃ³n (Ej: 4 semanas)" [(ngModel)]="cursoAEditar.duracion" name="duracion_edit" required>
        <input type="text" placeholder="Horario (Ej: Lunes 7pm a 10pm)" [(ngModel)]="cursoAEditar.horario" name="horario_edit" required>
        <input type="number"
                placeholder="Precio (Ej: 100.00)"
                [(ngModel)]="cursoAEditar.precio"
                name="precio_edit"
                required
                min="1"
                (input)="validarPrecioEdicion()">
        <input type="text" placeholder="Modalidad (Ej:Presencial o Virtual)" [(ngModel)]="cursoAEditar.modalidad" name="modalidad_edit" required>
        <input type="text" placeholder="Incluye (Ej: certificado)" [(ngModel)]="cursoAEditar.extra" name="extra_edit">
        <select [(ngModel)]="cursoAEditar.estado" name="estado_edit">
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
        </select>
        <div>
            <button type="submit">Guardar Cambios</button>
            <button type="button" (click)="modalEditarCurso.close()">Cancelar</button>
        </div>
    </form>
</dialog>

    <dialog #modalCurso>
      <h3>â• Registrar Curso</h3>
      <form (submit)="registrarCurso(); modalCurso.close(); $event.preventDefault()">
        <input type="text" placeholder="Nombre del curso " [(ngModel)]="nuevoCurso.nombre" name="nombre" required>
        <input type="text" placeholder="DuraciÃ³n (Ej: 4 semanas)" [(ngModel)]="nuevoCurso.duracion" name="duracion" required>
        <input type="text" placeholder="Horario (Ej: Lunes 7pm a 10pm)" [(ngModel)]="nuevoCurso.horario" name="horario" required>
        <!--<input type="number" placeholder="Precio" [(ngModel)]="nuevoCurso.precio" name="precio" required>-->
        <input type="number"
       placeholder="Precio (Ej: 100.00)"
       [(ngModel)]="nuevoCurso.precio"
       name="precio"
       required
       min="1"
       (input)="validarPrecio()">

        <input type="text" placeholder="Modalidad (Ej:Presencial o Virtual)" [(ngModel)]="nuevoCurso.modalidad" name="modalidad" required>
        <input type="text" placeholder="Incluye (Ej: certificado)" [(ngModel)]="nuevoCurso.extra" name="extra">
        <select [(ngModel)]="nuevoCurso.estado" name="estado" disabled>
          <option value="activo">Activo</option> 
          <option value="inactivo">Inactivo</option>
        </select>
        <div>
          <button type="submit">Guardar</button>
          <button type="button" (click)="modalCurso.close()">Cancelar</button>
        </div>
      </form>
    </dialog>

  </div>


  <!-- Modal simple -->
<div class="modal" [ngClass]="{ 'show': mostrarModal }" [ngStyle]="{ 'display': mostrarModal ? 'flex' : 'none' }">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Mensaje</h5>
        <button type="button" class="btn-close" aria-label="Cerrar" (click)="cerrarModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p>{{ mensajeModal }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<dialog #modalPermiso>
  <h3>{{ tituloModalPermiso }}</h3>
  <p>{{ mensajePermiso }}</p>
  <div>
    <button (click)="modalPermiso.close()">Cerrar</button>
  </div>
</dialog>

<!-- Solo el administrador ve el cÃ³digo QR -->
    <div *ngIf="tipoUsuario === 'administrador'" class="qr-container">
      <h3>ğŸ“· CÃ³digo QR para Escaneo</h3>
      <!--<p style="color: gray; font-size: 0.8rem;">Contenido del QR: {{ qrData }}</p>-->

      <p>ğŸ“Œ Los usuarios estÃ¡ndar pueden escanear este cÃ³digo para recibir puntos.</p>

      <qrcode 
        [qrdata]="qrData" 
        [width]="200" 
        [errorCorrectionLevel]="'M'">
      </qrcode>
    </div>

</div>
